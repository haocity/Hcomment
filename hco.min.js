"use strict";function Hco(e,t,a){function l(t){return e.querySelector(t)}var i=document.createElement("div");this.ele=i,this.cid=t+"_"+a,i.className="ew-comment",i.innerHTML='<div class="ew-publish">\n\t\t\t\t<div class="ew-publish-title">正在回复 <span class="ew-publish-title-lc">#0</span> <span class="ew-publish-back">返回评论</span></div>\n\t\t\t\t\t<div class="ew-textarea-warp">\n\t\t\t\t\t\t<textarea node-type="textarea" name="" class="ew-textarea" placeholder="评论.." autocomplete="off" spellcheck="false"></textarea>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="ew-info">\n\t\t\t\t\t\t<input class="text-block ew-author"  name="author" type="text" value="" size="30" placeholder="昵称 *" autocomplete="off">\n\t\t\t\t\t\t<input class="text-block ew-email"  name="email" type="email" value="" size="30" placeholder="邮箱 *" autocomplete="off">\n\t\t\t\t\t\t<input class="text-block ew-weburl"  name="url" type="url" value="" size="30" placeholder="网址" autocomplete="off">\n\t\t\t\t\t\t<div class="ew-send-btn">发送</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="ew-bar">喵喵</div>\n\t\t\t\t<div class="ew-list">\n\t\t\t\t</div>',"string"==typeof e&&(e=document.querySelector(e)),e.appendChild(i);var n=this;if(this.$c=l,new Object,this.now="father",this.id=this.cid,this.api="https://t5.haotown.cn/hcon",this.publish=l(".ew-publish"),localStorage.getItem("ew")){console.log("加载设置成功");var s=JSON.parse(localStorage.getItem("ew"));l(".ew-email").value=s.email,l(".ew-author").value=s.user,l(".ew-weburl").value=s.weburl}l(".ew-textarea").addEventListener("keydown",function(e){13==e.keyCode&&e.ctrlKey&&l(".ew-send-btn").click()},!1),l(".ew-send-btn").addEventListener("click",function(){n.submitfun()},!1),l(".ew-publish-back").addEventListener("click",function(){n.now="father",n.publish.className="ew-publish";for(var e=document.querySelectorAll(".ew-li-main"),t=0;t<e.length;t++)e[t].style.marginBottom&&(e[t].style.marginBottom="auto")},!1),n.update()}Hco.prototype.alert=function(e){var t=document.createElement("div");t.className="ew-alert",t.innerText=e,document.body.appendChild(t),setTimeout(function(){t.style.display="none",t.remove()},1900)},Hco.prototype.getfloor=function(e){for(var t="#",a=e.toString(),l=a.split("-"),i=0;i<l.length;i++)if(i==l.length-1){var n=parseInt(l[i])+1;t+=n}else t=t+(parseInt(l[i])+1)+"-";return t},Hco.prototype.gettime=function(e){var t=void 0,a=(new Date).getTime(),l=a-e;if(l<6e4)t="刚刚";else if(l<36e5)t=new Date(l).getMinutes()+"分钟前";else if(l<864e5)t=new Date(l).getHours()+"小时前";else{var i=new Date(parseInt(e));t=i.getFullYear()+"年"+i.getMonth()+"月"+i.getDay()+"日"}return t},Hco.prototype.update=function(e){var t=this,a=new XMLHttpRequest;a.onreadystatechange=function(){if(4==a.readyState&&200==a.status){var l=JSON.parse(a.responseText);t.$c(".ew-list").innerHTML="";for(var i=0;i<l.data.length;i++){var n=l.data[i];t.sendcom(n.cid,n.user,n.email,n.weburl,n.time,n.text)}"father"!=e&&void 0!=e&&t.$c(".ew-id-"+e+">.ew-li-main>.ew-li-com-w>.ew-li-reply")&&t.$c(".ew-id-"+e+">.ew-li-main>.ew-li-com-w>.ew-li-reply").click()}},a.open("GET",this.api+"/get/?id="+this.cid,!0),a.send()},Hco.prototype.sendcom=function(e,t,a,l,i,n){var s=this,r=document.createElement("div"),o=void 0;"father"==e?(o=s.$c(".ew-list").querySelectorAll(".ew-li"),r.className="ew-li ew-id-"+o.length):s.$c(".ew-id-"+e)?(o=s.$c(".ew-id-"+e).querySelectorAll(".ew-li"),r.className="ew-li ew-id-"+e+"-"+o.length):console.log("数据可能存在错误");var c='<div class="ew-li-main">\n\t\t\t\t\t\t\t<div class="ew-li-logo" style="background-image:url(https://v2ex.assets.uxengine.net/gravatar/'+MD5(a)+'?s=80&d=retro)"></div>\n\t\t\t\t\t\t\t<div class="ew-li-com-w">\n\t\t\t\t\t\t\t\t<div class="ew-li-user"><a href="'+l+'">'+t+'</a></div>\n\t\t\t\t\t\t\t\t<div class="ew-li-time">'+s.gettime(i)+'</div>\n\t\t\t\t\t\t\t\t<pre class="ew-li-com">'+n+'</pre>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="ew-li-next"></div>\n\t\t\t\t\t\t</div>';r.innerHTML=c,r.m=a;var u=document.createElement("div");u.className="ew-li-reply",u.innerHTML="回复",u.addEventListener("click",function(){s.now=this.i;for(var e=document.querySelectorAll(".ew-li-main"),t=0;t<e.length;t++)e[t].style.marginBottom&&(e[t].style.marginBottom="auto");var a=r.querySelector(".ew-li-main");s.publish.className="ew-publish ew-publish-fly",s.publish.style.top=a.offsetHeight+a.offsetTop+"px",a.style.marginBottom="250px",s.$c(".ew-publish-title-lc").innerHTML=s.getfloor(this.i)},!1),r.querySelector(".ew-li-main>.ew-li-com-w").appendChild(u),"father"==e?(u.i=o.length,s.$c(".ew-list").appendChild(r)):s.$c(".ew-id-"+e+">.ew-li-next")?(u.i=e+"-"+o.length,s.$c(".ew-id-"+e+">.ew-li-next").appendChild(r)):console.log("数据可能存在错误"+e)},Hco.prototype.submitfun=function(){var e=this,t=/^([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+@([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+\.[a-zA-Z]{2,3}$/;if(e.$c(".ew-textarea").value.length<=6)e.alert("内容太短了");else if(e.$c(".ew-author").value)if(t.test(e.$c(".ew-email").value)){for(var a=(new Date,[/\n/g,/<script/g,/<\/script/g,/<style/g,/<\/style/g,/<\/div/g,/<div/g,/<\/pre/g,/<[a-z]+\s+on[a-z]+\s+?=/g]),l=0;l<a.length;l++)var i=e.$c(".ew-textarea").value.replace(a[l],"<br>");var n="";"father"!=e.now&&(n=this.$c(".ew-id-"+this.now).m);var s={id:e.id,user:e.$c(".ew-author").value,email:e.$c(".ew-email").value,weburl:e.$c(".ew-weburl").value,text:i,cid:e.now,url:document.location.href,title:document.title,pm:n};s=function(e){var t="";for(var a in e)t+=a+"="+e[a]+"&";return t}(s);var r=new XMLHttpRequest;r.open("POST",e.api+"/send/",!0),r.setRequestHeader("Content-type","application/x-www-form-urlencoded"),r.onreadystatechange=function(){var t=r;if(4==t.readyState&&200==t.status)if(JSON.parse(t.responseText).success){e.update(e.now),e.alert("评论成功"),e.$c(".ew-textarea").value="";var a='{"user":"'+e.$c(".ew-author").value+'","email":"'+e.$c(".ew-email").value+'","weburl":"'+e.$c(".ew-weburl").value+'"}';localStorage.setItem("ew",a)}else e.alert("发送失败")},r.send(s)}else e.alert("邮箱错误");else e.alert("请输入用户名")};